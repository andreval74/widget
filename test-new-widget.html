<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste New Widget</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Ethers.js via UNPKG -->
    <script src="https://unpkg.com/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    
    <style>
        body {
            background-color: #f8f9fa;
            padding: 20px;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>üß™ Teste New Widget</h1>
    
    <div class="card mb-4">
        <div class="card-header">
            <h5>Status das Depend√™ncias</h5>
        </div>
        <div class="card-body">
            <div id="status-output"></div>
        </div>
    </div>
    
    <div class="card">
        <div class="card-header">
            <h5>Teste de Detec√ß√£o de Token</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-4">
                    <label for="networkSelect" class="form-label">Rede</label>
                    <select id="networkSelect" class="form-select">
                        <option value="">Escolha uma rede...</option>
                        <option value="56">BNB Smart Chain</option>
                        <option value="97">BSC Testnet</option>
                    </select>
                </div>
                <div class="col-md-6">
                    <label for="tokenAddress" class="form-label">Endere√ßo do Token</label>
                    <input type="text" id="tokenAddress" class="form-control" 
                           placeholder="0x8AC76a51cc950d9822D68b83fE1Ad97B32Cd580d">
                </div>
                <div class="col-md-2">
                    <label class="form-label">&nbsp;</label>
                    <button id="detectBtn" class="btn btn-primary w-100">Detectar</button>
                </div>
            </div>
            
            <div id="result" class="mt-4" style="display: none;"></div>
        </div>
    </div>
</div>

<script>
console.log('üß™ Teste New Widget iniciado');

// Verificar status
function updateStatus() {
    const statusDiv = document.getElementById('status-output');
    const status = {
        'Ethers.js': typeof ethers !== 'undefined' ? '‚úÖ' : '‚ùå',
        'MetaMask': typeof window.ethereum !== 'undefined' ? '‚úÖ' : '‚ùå',
        'Bootstrap': typeof bootstrap !== 'undefined' ? '‚úÖ' : '‚ùå'
    };
    
    statusDiv.innerHTML = Object.entries(status)
        .map(([key, value]) => `<span class="badge bg-${value === '‚úÖ' ? 'success' : 'danger'} me-2">${key}: ${value}</span>`)
        .join('');
}

// Configura√ß√£o de redes
const networks = {
    '56': {
        name: 'BNB Smart Chain',
        rpc: ['https://bsc-dataseed.binance.org/'],
        chainId: 56
    },
    '97': {
        name: 'BSC Testnet', 
        rpc: ['https://data-seed-prebsc-1-s1.binance.org:8545/'],
        chainId: 97
    }
};

// Fun√ß√£o de detec√ß√£o
async function detectToken() {
    const networkId = document.getElementById('networkSelect').value;
    const address = document.getElementById('tokenAddress').value.trim();
    const resultDiv = document.getElementById('result');
    
    console.log('üîç Iniciando detec√ß√£o:', { networkId, address });
    
    if (!networkId || !address) {
        resultDiv.innerHTML = '<div class="alert alert-warning">Selecione uma rede e digite um endere√ßo</div>';
        resultDiv.style.display = 'block';
        return;
    }
    
    if (typeof ethers === 'undefined') {
        resultDiv.innerHTML = '<div class="alert alert-danger">‚ùå Ethers.js n√£o carregado</div>';
        resultDiv.style.display = 'block';
        return;
    }
    
    try {
        resultDiv.innerHTML = '<div class="alert alert-info">üîç Detectando...</div>';
        resultDiv.style.display = 'block';
        
        const network = networks[networkId];
        const provider = new ethers.providers.JsonRpcProvider(network.rpc[0]);
        
        console.log('üåê Provider criado:', network.name);
        
        // Verificar se √© contrato
        const code = await provider.getCode(address);
        if (code === '0x') {
            throw new Error('Endere√ßo n√£o √© um contrato inteligente');
        }
        
        // ABI ERC20
        const abi = [
            "function name() view returns (string)",
            "function symbol() view returns (string)",
            "function decimals() view returns (uint8)"
        ];
        
        const contract = new ethers.Contract(address, abi, provider);
        console.log('üìÑ Contrato criado');
        
        // Buscar dados
        const [name, symbol, decimals] = await Promise.all([
            contract.name().catch(() => 'N/A'),
            contract.symbol().catch(() => 'N/A'),
            contract.decimals().catch(() => 18)
        ]);
        
        console.log('‚úÖ Token detectado:', { name, symbol, decimals });
        
        resultDiv.innerHTML = `
            <div class="alert alert-success">
                <h6>‚úÖ Token Detectado!</h6>
                <p><strong>Nome:</strong> ${name}</p>
                <p><strong>S√≠mbolo:</strong> ${symbol}</p>
                <p><strong>Decimais:</strong> ${decimals}</p>
                <p><strong>Rede:</strong> ${network.name}</p>
            </div>
        `;
        
    } catch (error) {
        console.error('‚ùå Erro:', error);
        resultDiv.innerHTML = `
            <div class="alert alert-danger">
                <h6>‚ùå Erro na Detec√ß√£o</h6>
                <p>${error.message}</p>
            </div>
        `;
    }
}

// Event listeners
document.addEventListener('DOMContentLoaded', function() {
    console.log('üìã DOM carregado');
    updateStatus();
    
    document.getElementById('detectBtn').addEventListener('click', detectToken);
});
</script>

</body>
</html>